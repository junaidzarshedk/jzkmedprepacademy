<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Secure Video Content Hub | JZK Medical Academy</title>
  
  <!-- SEO Meta Tags -->
  <meta name="description" content="Access secure, role-based medical video content at JZK Medical Academy. Verified members and admins can upload and watch educational videos.">
  <meta name="keywords" content="Medical Academy, Secure Video Hub, Educational Videos, JZK, Firestore, Firebase">
  <meta name="author" content="JZK Medical Academy">

  <!-- Open Graph (Facebook, LinkedIn) -->
  <meta property="og:title" content="Secure Video Content Hub | JZK Medical Academy">
  <meta property="og:description" content="Role-based secure video content hub for medical education.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://your-domain.com/">
  <meta property="og:image" content="https://your-domain.com/preview.jpg">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Secure Video Content Hub | JZK Medical Academy">
  <meta name="twitter:description" content="Verified members can access secure medical video content.">
  <meta name="twitter:image" content="https://your-domain.com/preview.jpg">

  <!-- Structured Data for Google -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "VideoGallery",
    "name": "Secure Video Content Hub",
    "url": "https://your-domain.com/",
    "description": "Role-based secure video content hub for medical education.",
    "creator": {
      "@type": "Organization",
      "name": "JZK Medical Academy"
    }
  }
  </script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>
<body class="bg-gray-50">

  <!-- Static fallback for SEO -->
  <noscript>
    <main class="max-w-2xl mx-auto p-6">
      <h1>Secure Video Content Hub - JZK Medical Academy</h1>
      <p>Access educational videos securely with role-based authentication. Please enable JavaScript for the full experience.</p>
    </main>
  </noscript>

  <!-- App Container -->
  <div id="app-container" class="min-h-screen p-4 sm:p-8 font-sans"></div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, getDoc, runTransaction } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyAuRYUMj--teABPMoesz8H4olnEP6m9f5c",
      authDomain: "jzkmedicalacademy.firebaseapp.com",
      projectId: "jzkmedicalacademy",
      storageBucket: "jzkmedicalacademy.firebasestorage.app",
      messagingSenderId: "365322761401",
      appId: "1:365322761401:web:42c125319838708077d768",
      measurementId: "G-D531515KZX"
    };

    // --- App Vars ---
    const appId = "default-app-id";
    const CONFIG_PATH = `artifacts/${appId}/public/data/config`;
    const VIDEOS_COLLECTION_PATH = `artifacts/${appId}/public/data/videos`;
    const getUserProfilePath = (uid) => `artifacts/${appId}/users/${uid}/profile/status`;

    let db, auth, userId, isAuthReady = false, isAdmin = false, isMemberVerified = false;
    let videos = [], statusMessage = '';

    // --- Init Firebase ---
    const initFirebase = () => {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
      onAuthStateChanged(auth, async (user) => {
        userId = user ? user.uid : null;
        if (!user) await signInAnonymously(auth);
        isAuthReady = true;
        await checkUserStatus();
        startListeners();
        renderApp();
      });
    };

    // --- User Roles ---
    const checkUserStatus = async () => {
      if (!db || !userId) return;
      try {
        let currentAdminId = null;
        const adminDocRef = doc(db, CONFIG_PATH, 'admin_id');
        await runTransaction(db, async (tx) => {
          const adminDoc = await tx.get(adminDocRef);
          if (!adminDoc.exists()) {
            tx.set(adminDocRef, { adminUid: userId });
            currentAdminId = userId;
          } else currentAdminId = adminDoc.data().adminUid;
        });
        isAdmin = userId === currentAdminId;
        const profileDoc = await getDoc(doc(db, getUserProfilePath(userId)));
        isMemberVerified = profileDoc.exists() ? profileDoc.data().verified === true : false;
      } catch (err) { console.error("Role check error:", err); }
    };

    // --- Firestore Listeners ---
    const startListeners = () => {
      if (!db) return;
      const q = query(collection(db, VIDEOS_COLLECTION_PATH));
      onSnapshot(q, (snap) => {
        videos = snap.docs.map(d => ({ id: d.id, ...d.data() }))
                 .sort((a, b) => b.timestamp - a.timestamp);
        renderApp();
      });
    };

    // --- Render App (SEO-friendly markup) ---
    const renderApp = () => {
      const container = document.getElementById("app-container");
      if (!isAuthReady || !db || !userId) {
        container.innerHTML = `<section><h2>Loading...</h2><p>Setting up authentication...</p></section>`;
        return;
      }
      const roleDisplay = isAdmin ? "Admin" : (isMemberVerified ? "Verified Member" : "Guest");
      let html = `
        <header class="mb-10">
          <h1 class="text-3xl font-bold">Secure Video Content Hub</h1>
          <p class="text-gray-600">Access educational videos securely with role-based authentication.</p>
          <p><strong>Role:</strong> ${roleDisplay}</p>
        </header>
        <main>
      `;
      if (isAdmin) {
        html += `
          <section>
            <h2>Upload New Video</h2>
            <form id="upload-form" class="mb-6">
              <input id="title" type="text" placeholder="Video Title" required class="border p-2 mb-2 w-full"/>
              <input id="url" type="url" placeholder="Video URL" required class="border p-2 mb-2 w-full"/>
              <button id="upload-button" class="bg-blue-600 text-white px-4 py-2 rounded">Add Video</button>
            </form>
          </section>
        `;
      }
      if (isAdmin || isMemberVerified) {
        html += `
          <section>
            <h2>Available Videos</h2>
            ${videos.length === 0 
              ? "<p>No videos uploaded yet.</p>" 
              : videos.map(v => `
                  <article class="border p-4 mb-3 rounded">
                    <h3 class="font-bold">${v.title}</h3>
                    <p>Uploaded on ${new Date(v.timestamp).toLocaleDateString()}</p>
                    <a href="${v.url}" target="_blank" rel="noopener" class="text-blue-600">Watch Video</a>
                  </article>
                `).join("")}
          </section>
        `;
      } else {
        html += `<section><p>You must be a verified member to view video content.</p></section>`;
      }
      html += `</main>`;
      container.innerHTML = html;

      // Bind Events
      if (isAdmin) {
        document.getElementById("upload-form")?.addEventListener("submit", async (e) => {
          e.preventDefault();
          const title = e.target.title.value.trim();
          const url = e.target.url.value.trim();
          if (!title || !url) return;
          await addDoc(collection(db, VIDEOS_COLLECTION_PATH), {
            title, url, timestamp: Date.now(), uploadedBy: userId
          });
          e.target.reset();
        });
      }
    };

    window.onload = initFirebase;
  </script>
</body>
</html>
