<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Secure Video Content Hub</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>
<body class="bg-gray-50">

  <div id="app-container" class="min-h-screen p-4 sm:p-8 font-sans"></div>

  <!-- Firebase SDK -->
  <script type="module">
    // Import Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, getDoc, runTransaction } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // --- Your Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyAuRYUMj--teABPMoesz8H4olnEP6m9f5c",
      authDomain: "jzkmedicalacademy.firebaseapp.com",
      projectId: "jzkmedicalacademy",
      storageBucket: "jzkmedicalacademy.firebasestorage.app",
      messagingSenderId: "365322761401",
      appId: "1:365322761401:web:42c125319838708077d768",
      measurementId: "G-D531515KZX"
    };

    // --- App-wide Vars ---
    const appId = "default-app-id";
    const CONFIG_PATH = `artifacts/${appId}/public/data/config`;
    const VIDEOS_COLLECTION_PATH = `artifacts/${appId}/public/data/videos`;
    const getUserProfilePath = (uid) => `artifacts/${appId}/users/${uid}/profile/status`;

    let db = null, auth = null, userId = null;
    let isAuthReady = false, isAdmin = false, isMemberVerified = false;
    let videos = [], statusMessage = '';

    // --- UI Helpers ---
    const StatusCard = (message, iconSvg, colorClass = 'text-gray-500') => `
      <div class="flex flex-col items-center justify-center p-8 bg-white rounded-xl shadow-inner border border-gray-100">
        <div class="p-3 rounded-full ${colorClass} bg-opacity-10 mb-4">${iconSvg}</div>
        <p class="text-lg font-medium text-gray-700 text-center max-w-sm">${message}</p>
      </div>
    `;

    const Button = (text, iconSvg, id, primary = true, disabled = false, className = '') => `
      <button id="${id}" ${disabled ? 'disabled' : ''} 
        class="flex items-center justify-center space-x-2 px-6 py-3 text-base font-semibold rounded-xl transition duration-300 shadow-lg
               ${primary ? 'bg-blue-600 hover:bg-blue-700 text-white disabled:bg-blue-400'
                         : 'bg-gray-200 hover:bg-gray-300 text-gray-800 disabled:bg-gray-100'}
               ${disabled ? 'cursor-not-allowed opacity-75' : 'hover:scale-[1.02]'} ${className}">
        ${iconSvg}<span>${text}</span>
      </button>
    `;

    // --- Firebase Init ---
    const initFirebase = () => {
      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        onAuthStateChanged(auth, async (user) => {
          if (user) {
            userId = user.uid;
          } else {
            await signInAnonymously(auth);
          }
          isAuthReady = true;
          await checkUserStatus();
          startListeners();
          renderApp();
        });
      } catch (e) {
        console.error("Error initializing Firebase:", e);
        isAuthReady = true;
        statusMessage = "Failed to connect to Firebase.";
        renderApp();
      }
    };

    // --- User Role Check ---
    const checkUserStatus = async () => {
      if (!db || !userId) return;
      try {
        let currentAdminId = null;
        const adminDocRef = doc(db, CONFIG_PATH, 'admin_id');
        await runTransaction(db, async (tx) => {
          const adminDoc = await tx.get(adminDocRef);
          if (!adminDoc.exists()) {
            tx.set(adminDocRef, { adminUid: userId });
            currentAdminId = userId;
          } else currentAdminId = adminDoc.data().adminUid;
        });
        isAdmin = userId === currentAdminId;

        const profileDocRef = doc(db, getUserProfilePath(userId));
        const profileDoc = await getDoc(profileDocRef);
        isMemberVerified = profileDoc.exists() ? profileDoc.data().verified === true : false;
      } catch (err) {
        console.error("Error checking user status:", err);
        statusMessage = "Could not verify user roles.";
      }
    };

    // --- Firestore Listeners ---
    const startListeners = () => {
      if (!db) return;
      const videosQuery = query(collection(db, VIDEOS_COLLECTION_PATH));
      onSnapshot(videosQuery, (snapshot) => {
        videos = snapshot.docs.map(d => ({ id: d.id, ...d.data() }))
                   .sort((a, b) => b.timestamp - a.timestamp);
        renderApp();
      });
    };

    // --- Toggle Verification ---
    const toggleVerificationStatus = async () => {
      if (!db || !userId) return;
      const newStatus = !isMemberVerified;
      try {
        await setDoc(doc(db, getUserProfilePath(userId)), { verified: newStatus }, { merge: true });
        isMemberVerified = newStatus;
        statusMessage = newStatus ? "You are now a Verified Member!" : "Verification revoked.";
        renderApp();
      } catch (err) {
        console.error("Error toggling verification:", err);
        statusMessage = "Failed to update verification.";
        renderApp();
      }
    };

    // --- Admin Upload ---
    const handleUpload = async (e) => {
      e.preventDefault();
      const form = e.target;
      const title = form.querySelector('#title').value.trim();
      const url = form.querySelector('#url').value.trim();
      const btn = form.querySelector('#upload-button');
      if (!title || !url) return;

      btn.disabled = true; btn.innerHTML = '<span>Adding...</span>';
      try {
        await addDoc(collection(db, VIDEOS_COLLECTION_PATH), {
          title, url, timestamp: Date.now(), uploadedBy: userId
        });
        form.reset();
        statusMessage = "Video saved!";
      } catch (err) {
        console.error("Error adding doc:", err);
        statusMessage = "Failed to add video.";
      } finally {
        btn.disabled = false;
        renderApp();
      }
    };

    // --- Render App ---
    const renderApp = () => {
      const container = document.getElementById('app-container');
      if (!isAuthReady || !db || !userId) {
        container.innerHTML = StatusCard("Setting up authentication...", "üîÑ", "text-blue-600");
        return;
      }
      const roleDisplay = isAdmin ? "Admin" : (isMemberVerified ? "Verified Member" : "Guest");
      const roleColor = isAdmin ? "text-red-500" : (isMemberVerified ? "text-green-500" : "text-gray-500");

      let header = `
        <header class="mb-10 p-6 bg-white rounded-xl shadow-2xl border-b-4 border-blue-600/50">
          <h1 class="text-4xl font-extrabold mb-2">Secure Video Content Hub</h1>
          <p class="text-gray-600 mb-4">Role-based access demo.</p>
          <div class="flex justify-between items-center p-4 bg-blue-50 rounded-lg border">
            <div>
              <p>User ID: <span class="ml-1 font-mono text-xs bg-blue-100 px-2 py-0.5 rounded">${userId}</span></p>
              <p>Your Role: <span class="ml-1 font-bold ${roleColor}">${roleDisplay}</span></p>
            </div>
            ${!isAdmin ? Button(
              isMemberVerified ? "Revoke Verification" : "Simulate Verification",
              "‚úîÔ∏è", "toggle-verification-btn",
              !isMemberVerified, false, "w-auto"
            ) : ""}
          </div>
        </header>
      `;

      let main = "";
      if (isAdmin) {
        main += `
          <form id="upload-form" class="p-6 bg-white rounded-xl shadow-lg mb-6">
            <h2 class="text-xl font-bold mb-4">Admin Video Uploader</h2>
            <input id="title" type="text" placeholder="Video Title" class="block w-full mb-2 p-2 border rounded"/>
            <input id="url" type="url" placeholder="Video URL" class="block w-full mb-2 p-2 border rounded"/>
            ${Button("Add Video", "‚ûï", "upload-button")}
          </form>
        `;
      }
      if (isAdmin || isMemberVerified) {
        main += videos.length === 0
          ? StatusCard("No videos uploaded yet.", "üìπ", "text-yellow-600")
          : `<div class="grid gap-4">${videos.map(v => `
               <div class="bg-white p-4 rounded shadow">
                 <h3 class="font-bold">${v.title}</h3>
                 <p class="text-sm text-gray-500">${new Date(v.timestamp).toLocaleString()}</p>
                 <a href="${v.url}" target="_blank" class="text-blue-600">Watch</a>
               </div>`).join("")}</div>`;
      } else {
        main += StatusCard("You must be verified to view videos.", "üîí", "text-red-600");
      }

      container.innerHTML = header + `<main>${main}</main>`;

      // Event bindings
      const toggleBtn = document.getElementById("toggle-verification-btn");
      if (toggleBtn) toggleBtn.addEventListener("click", toggleVerificationStatus);
      if (isAdmin) {
        const form = document.getElementById("upload-form");
        if (form) form.addEventListener("submit", handleUpload);
      }
    };

    window.onload = initFirebase;
  </script>
</body>
</html>
