<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Video Content Hub</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50">

    <div id="app-container" class="min-h-screen p-4 sm:p-8 font-sans">
        <!-- The main application content will be rendered here by JavaScript -->
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, getDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Using Lucide icons via a simple function, as direct React imports are not available.
        // We'll use simple inline SVGs instead for the icons.

        // --- Global Variable Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Firestore Path Helpers ---
        const CONFIG_PATH = `artifacts/${appId}/public/data/config`;
        const VIDEOS_COLLECTION_PATH = `artifacts/${appId}/public/data/videos`;
        const getUserProfilePath = (uid) => `artifacts/${appId}/users/${uid}/profile/status`;

        // --- Application State ---
        let db = null;
        let auth = null;
        let userId = null;
        let isAuthReady = false;
        let isAdmin = false;
        let isMemberVerified = false;
        let videos = [];
        let statusMessage = '';

        // --- Utility Functions (Mimicking React Components) ---

        /**
         * Renders a custom status card message.
         * @param {string} message - The text message.
         * @param {string} iconSvg - Inline SVG for the icon.
         * @param {string} colorClass - Tailwind color class for the icon.
         */
        const StatusCard = (message, iconSvg, colorClass = 'text-gray-500') => `
            <div class="flex flex-col items-center justify-center p-8 bg-white rounded-xl shadow-inner border border-gray-100">
                <div class="p-3 rounded-full ${colorClass} bg-opacity-10 mb-4">
                    ${iconSvg}
                </div>
                <p class="text-lg font-medium text-gray-700 text-center max-w-sm">${message}</p>
            </div>
        `;

        /**
         * Renders a reusable button component.
         * @param {string} text - Button text.
         * @param {string} iconSvg - Inline SVG for the icon.
         * @param {string} id - DOM ID for event listeners.
         * @param {boolean} primary - Primary (blue) or secondary (gray) style.
         * @param {boolean} disabled - Whether the button is disabled.
         * @param {string} className - Additional classes.
         */
        const Button = (text, iconSvg, id, primary = true, disabled = false, className = '') => `
            <button
                id="${id}"
                ${disabled ? 'disabled' : ''}
                class="
                    flex items-center justify-center space-x-2 px-6 py-3 text-base font-semibold rounded-xl transition duration-300 shadow-lg
                    ${primary
                        ? 'bg-blue-600 hover:bg-blue-700 text-white disabled:bg-blue-400'
                        : 'bg-gray-200 hover:bg-gray-300 text-gray-800 disabled:bg-gray-100'}
                    ${disabled ? 'cursor-not-allowed opacity-75' : 'hover:scale-[1.02]'}
                    ${className}
                "
            >
                ${iconSvg}
                <span>${text}</span>
            </button>
        `;

        // --- Core Application Logic ---

        /**
         * Initializes Firebase and sets up the authentication listener.
         */
        const initFirebase = () => {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing.");
                statusMessage = "Failed to connect to Firebase: Configuration error.";
                renderApp();
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } catch (error) {
                            console.error("Custom token sign-in failed, signing in anonymously.", error);
                            await signInAnonymously(auth);
                        }
                    } else {
                        await signInAnonymously(auth);
                    }
                    isAuthReady = true;
                    await checkUserStatus();
                    startListeners();
                    renderApp();
                });
            } catch (e) {
                console.error("Error initializing Firebase:", e);
                isAuthReady = true;
                statusMessage = "Failed to connect to Firebase. Check console for details.";
                renderApp();
            }
        };

        /**
         * Checks and sets the admin and member verification status using Firestore.
         */
        const checkUserStatus = async () => {
            if (!db || !userId) return;

            try {
                // --- Admin Check: Use transaction to ensure only the first user becomes admin ---
                let currentAdminId = null;
                const adminDocRef = doc(db, CONFIG_PATH, 'admin_id');

                await runTransaction(db, async (transaction) => {
                    const adminDoc = await transaction.get(adminDocRef);

                    if (!adminDoc.exists()) {
                        transaction.set(adminDocRef, { adminUid: userId });
                        currentAdminId = userId;
                    } else {
                        currentAdminId = adminDoc.data().adminUid;
                    }
                });

                isAdmin = userId === currentAdminId;

                // --- Member Verification Check (Private Data) ---
                const profileDocRef = doc(db, getUserProfilePath(userId));
                const profileDoc = await getDoc(profileDocRef);

                isMemberVerified = profileDoc.exists() ? profileDoc.data().verified === true : false;

            } catch (error) {
                console.error("Error checking user status:", error);
                statusMessage = "Could not verify user roles. Check console.";
                isAdmin = false;
                isMemberVerified = false;
            }
        };

        /**
         * Sets up the real-time listener for the videos collection.
         */
        const startListeners = () => {
            if (!db) return;

            const videosQuery = query(collection(db, VIDEOS_COLLECTION_PATH));

            onSnapshot(videosQuery, (snapshot) => {
                videos = snapshot.docs.map(d => ({
                    id: d.id,
                    ...d.data(),
                })).sort((a, b) => b.timestamp - a.timestamp); // Sort newest first
                renderApp();
            }, (error) => {
                console.error("Error fetching videos:", error);
                statusMessage = "Error fetching videos. Data access might be restricted.";
                renderApp();
            });
        };

        /**
         * Toggles the user's member verification status.
         */
        const toggleVerificationStatus = async () => {
            if (!db || !userId) return;

            statusMessage = '';
            const newStatus = !isMemberVerified;
            const profileDocRef = doc(db, getUserProfilePath(userId));

            try {
                await setDoc(profileDocRef, { verified: newStatus }, { merge: true });
                isMemberVerified = newStatus;
                statusMessage = newStatus ? 'You are now a Verified Member!' : 'Verification revoked. You are now a Guest.';
                renderApp();
            } catch (error) {
                console.error("Error toggling verification:", error);
                statusMessage = "Failed to update verification status.";
                renderApp();
            }
        };

        /**
         * Handles the video upload form submission (Admin only).
         */
        const handleUpload = async (e) => {
            e.preventDefault();
            const form = e.target;
            const titleInput = form.querySelector('#title');
            const urlInput = form.querySelector('#url');
            const uploadButton = form.querySelector('#upload-button');

            const title = titleInput.value.trim();
            const url = urlInput.value.trim();

            if (!title || !url) {
                document.getElementById('upload-message').innerHTML = '<p class="text-sm mt-3 font-medium text-red-600">Both title and URL are required.</p>';
                return;
            }

            // Simple URL validation
            if (!url.startsWith('http')) {
                document.getElementById('upload-message').innerHTML = '<p class="text-sm mt-3 font-medium text-red-600">Please enter a valid URL (must start with http/https).</p>';
                return;
            }

            uploadButton.disabled = true;
            uploadButton.innerHTML = '<span>Adding...</span>';
            document.getElementById('upload-message').innerHTML = '';

            try {
                await addDoc(collection(db, VIDEOS_COLLECTION_PATH), {
                    title: title,
                    url: url,
                    timestamp: Date.now(),
                    uploadedBy: userId,
                });
                titleInput.value = '';
                urlInput.value = '';
                document.getElementById('upload-message').innerHTML = '<p class="text-sm mt-3 font-medium text-green-600">Video added successfully!</p>';
                statusMessage = 'Video saved!';
            } catch (error) {
                console.error('Error adding document: ', error);
                document.getElementById('upload-message').innerHTML = '<p class="text-sm mt-3 font-medium text-red-600">Failed to add video. Check console for details.</p>';
            } finally {
                uploadButton.disabled = false;
                uploadButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg><span>Add Video</span>';
                renderApp();
            }
        };

        // --- DOM Rendering Function ---

        const renderApp = () => {
            const container = document.getElementById('app-container');
            if (!container) return;

            // --- Loading State ---
            if (!isAuthReady || !db || !userId) {
                const loaderSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin w-6 h-6 mx-auto mb-2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>`;
                container.innerHTML = `
                    <div class="flex justify-center items-center min-h-screen">
                        ${StatusCard('Setting up library and authentication...', loaderSvg, 'text-blue-600')}
                    </div>
                `;
                return;
            }
            
            // --- Roles and UI Configuration ---
            const roleDisplay = isAdmin ? 'Admin' : (isMemberVerified ? 'Verified Member' : 'Unverified Guest');
            const roleColor = isAdmin ? 'text-red-500' : (isMemberVerified ? 'text-green-500' : 'text-gray-500');

            // --- Header HTML ---
            let headerHtml = `
                <header class="mb-10 p-6 bg-white rounded-xl shadow-2xl border-b-4 border-blue-600/50">
                    <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Secure Video Content Hub</h1>
                    <p class="text-gray-600 mb-4">Role-based access demonstration.</p>
                    <div class="flex flex-col md:flex-row md:justify-between md:items-center space-y-4 md:space-y-0 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="text-sm font-medium">
                            <p class="text-gray-800 flex items-center mb-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                Your User ID: <span class="ml-1 font-mono text-xs bg-blue-100 px-2 py-0.5 rounded text-blue-700">${userId}</span>
                            </p>
                            <p class="flex items-center">
                                Your Role: <span class="ml-1 font-bold ${roleColor}">${roleDisplay}</span>
                            </p>
                        </div>
                        <!-- Role Management/Simulation -->
                        ${!isAdmin ? `
                            ${Button(
                                isMemberVerified ? 'Revoke Verification (Go to Guest)' : 'Simulate Verification (Become Member)',
                                isMemberVerified 
                                    ? '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>' // Lock Icon
                                    : '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M22 11V3h-8"/><path d="M19 13.5V22l-4-4h-7V7a4 4 0 0 1 4-4h6z"/><path d="m14 20 4.5-4.5"/></svg>', // UserCheck Icon
                                'toggle-verification-btn',
                                !isMemberVerified, // primary if unverified, secondary if verified
                                false,
                                'w-full md:w-auto'
                            )}
                        ` : ''}
                    </div>
                </header>
            `;
            
            // --- Main Content Logic ---
            let mainContentHtml = '';

            if (isAdmin) {
                // Admin sees the uploader and the video list
                const shieldIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2 text-blue-600"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/></svg>`;
                const plusCircleIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>`;

                const videoUploaderHtml = `
                    <div class="p-6 bg-white rounded-xl shadow-2xl border border-blue-100">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center">
                            ${shieldIcon} Admin Video Uploader
                        </h2>
                        <p class="text-gray-600 mb-6">You are the designated administrator. Add new videos for verified members.</p>
                        <form id="upload-form" class="space-y-4">
                            <div>
                                <label for="title" class="block text-sm font-medium text-gray-700">Video Title</label>
                                <input id="title" type="text" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Introduction to Firestore" required/>
                            </div>
                            <div>
                                <label for="url" class="block text-sm font-medium text-gray-700">Video URL (e.g., YouTube Link)</label>
                                <input id="url" type="url" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500" placeholder="https://youtube.com/watch?v=..." required/>
                            </div>
                            ${Button('Add Video', plusCircleIcon, 'upload-button', true, false, 'w-full')}
                            <div id="upload-message"></div>
                        </form>
                    </div>
                `;

                mainContentHtml += `<div class="mb-8">${videoUploaderHtml}</div>`;
            }

            if (isAdmin || isMemberVerified) {
                // Video List for Admins and Verified Members
                if (videos.length === 0) {
                    const videoIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10"><path d="m22 8-6 4 6 4V8z"/><path d="M14 12c0 2.76-2.24 5-5 5H4c-2.76 0-5-2.24-5-5V7c0-2.76 2.24-5 5-5h5c2.76 0 5 2.24 5 5v5z"/></svg>`;
                    mainContentHtml += StatusCard('No videos have been uploaded yet. Please ask the administrator to add some content.', videoIcon, 'text-yellow-600');
                } else {
                    const videoIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2 text-green-600"><path d="m22 8-6 4 6 4V8z"/><path d="M14 12c0 2.76-2.24 5-5 5H4c-2.76 0-5-2.24-5-5V7c0-2.76 2.24-5 5-5h5c2.76 0 5 2.24 5 5v5z"/></svg>`;
                    let videoCardsHtml = videos.map(video => `
                        <div key="${video.id}" class="bg-white rounded-xl shadow-lg overflow-hidden transition duration-300 hover:shadow-xl border border-green-100">
                            <div class="p-4">
                                <h3 class="text-lg font-semibold text-gray-900 mb-2 truncate">${video.title}</h3>
                                <p class="text-sm text-gray-500 mb-4">Uploaded: ${new Date(video.timestamp).toLocaleDateString()}</p>
                                <a 
                                    href="${video.url}" 
                                    target="_blank" 
                                    rel="noopener noreferrer" 
                                    class="inline-flex items-center text-blue-600 hover:text-blue-800 transition duration-150 font-medium"
                                >
                                    Watch Video 
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 ml-1" viewBox="0 0 20 20" fill="currentColor">
                                      <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" />
                                      <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" />
                                    </svg>
                                </a>
                            </div>
                        </div>
                    `).join('');

                    mainContentHtml += `
                        <div class="space-y-4">
                            <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center">
                                ${videoIcon} Member Video Content
                            </h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                ${videoCardsHtml}
                            </div>
                        </div>
                    `;
                }
            } else {
                // Lock Screen for Unverified Guests
                const lockIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>`;
                mainContentHtml += StatusCard('You must be a verified paying member to access the video content.', lockIcon, 'text-red-600');
            }

            // --- Full App Layout ---
            let fullHtml = `<div class="max-w-6xl mx-auto">${headerHtml}`;
            
            // Status Message Area
            if (statusMessage) {
                fullHtml += `
                    <main class="mt-8">
                        <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6 rounded" role="alert">
                            <p class="font-bold">Status Update</p>
                            <p>${statusMessage}</p>
                        </div>
                        ${mainContentHtml}
                    </main>
                `;
            } else {
                fullHtml += `<main class="mt-8">${mainContentHtml}</main>`;
            }

            fullHtml += `</div>`;
            
            container.innerHTML = fullHtml;

            // --- Attach Event Listeners (After DOM update) ---
            
            // 1. Verification Toggle Button
            const toggleBtn = document.getElementById('toggle-verification-btn');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', toggleVerificationStatus);
            }

            // 2. Admin Upload Form (if admin)
            if (isAdmin) {
                const uploadForm = document.getElementById('upload-form');
                if (uploadForm) {
                    uploadForm.addEventListener('submit', handleUpload);
                }
            }
        };

        // Initialize the app when the window loads
        window.onload = initFirebase;
    </script>
</body>
</html>
